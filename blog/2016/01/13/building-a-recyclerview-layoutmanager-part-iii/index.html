
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a RecyclerView LayoutManager part III - Solarex's Blog</title>
  <meta name="author" content="Solarex">

  
  <meta name="description" content="In the previous post, we discussed adding proper support for data set changes and targeted scrolling. In this installment of the series, we will &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Solarex.github.io/blog/2016/01/13/building-a-recyclerview-layoutmanager-part-iii/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Solarex's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script>
    var _hmt = _hmt || [];
    (function() {
          var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?2574e8b2c205dfe8ff89e239fa38ca27";
              var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
    })();
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42746457-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Solarex's Blog</a></h1>
  
    <h2>我只想过，平平淡淡的生活，欲望啊，请放过脆弱的我</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Solarex.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://solarex.github.io/wiki">Wiki</a></li>
  <li><a href="/projects">Project</a></li>
  <li><a href="http://solarex.github.io/resume">Resume</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a RecyclerView LayoutManager Part III</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-13T00:48:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2016</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In the previous post, we discussed adding proper support for data set changes and targeted scrolling. In this installment of the series, we will focus on properly supporting animations in your fancy new LayoutManager.In case you’ve forgotten, the code samples are <a href="https://github.com/devunwired/recyclerview-playground">on GitHub</a>.</p>

<h2>The Problem With Free</h2>

<p>We talked about notifyDataSetChanged() the last time, but you may have noticed that changing the data in this way doesn’t animate the change**. RecyclerView includes a new API for making animated changes, which requires you to notify the adapter which positions in the adapter have changed, and what the action was:</p>

<ul>
<li><code>notifyItemInserted()</code> and <code>notifyItemRangeInserted()</code>: Insertion of new item(s) at the given position(s).</li>
<li><code>notifyItemChanged()</code> and <code>notifyItemRangeChanged()</code>: Invalidate he item(s) at the given position(s), nothing structural has changed in the data set.</li>
<li><code>notifyItemRemoved()</code> and <code>notifyItemRangeRemoved()</code>: Removal of the item(s) at the given position(s).</li>
<li><code>notifyItemMoved()</code>: An item has relocated to a new position in the data set.</li>
</ul>


<p>By default, your LayoutManager will get “simple item animations” for free when these methods are used. These animations are simply based on whether each current view position is still present in the layout after a change. New views are faded in, removed views are faded out, and other views are moved to their new location. Here’s what our grid layout looks like with the free animations:</p>

<center><img src="/images/building_recyclerview_layoutmanager_animation.gif" width="380" height="674" /></center>




<!-- more -->


<p>The problem here is that several items fade out that weren’t removed. This is because they are no longer visible inside the parent RecyclerView bounds. We would like the views to slide out of view towards where the user would expect them to go, but at this stage the framework only knows that our code didn’t lay them out again after the data set change took place. In addition, new views are fading in as if they were added. It would be better if these views slid into place from their expected locations as well.</p>

<p>The framework needs our help–we have to add a bit more to the <code>LayoutManager</code>…</p>

<h2>Predictive Item Animations</h2>

<p>The following animation represents what conceptually ought to happen when an item is removed:</p>

<center><img src="/images/building_recyclerview_layoutmanager_remove_animation.gif" width="667" height="400"></center>


<p>As we discussed in the first post of the series, <code>onLayoutChildren()</code> is typically only called once by the parent <code>RecyclerView</code> during the initial layout or when the data set size (i.e. item count) changes. The predictive item animations feature allows us to provide a more meaningful description of how the views should transition based on changes in the data. We need to start by indicating to the framework that our <code>LayoutManager</code> is able to provide this additional data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supportsPredictiveItemAnimations</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this one change, <code>onLayoutChildren()</code> will now be called twice for each batch of data set changes–first as a “pre-layout” phase, and again for the real layout.</p>

<h2>What Should I Do During Pre-Layout?</h2>

<p>During the pre-layout phase of <code>onLayoutChildren()</code>, you should run your layout logic to set up the initial conditions for the change animation. This means that you need to layout all the views that were currently visible before the change AND any additional views that you know will be visible after the animation runs (these are termed APPEARING views). These extra appearing views should be laid out in the off-screen positions where the user would expect them to be coming from. The framework will capture these positions and use them to animate the new views into place instead of doing a simple fade-in.We can check which layout phase we are in via <code>RecyclerView.State.isPreLayout()</code>.</p>

<p>In the <code>FixedGridLayoutManager</code> example, we use pre-layout to determine how many visible views are being removed as a result of the data set change. Removed views are still returned from the <code>Recycler</code> in pre-layout, so you can lay them out in their original location and not have to worry about accounting for an empty space. To indicate future removal to you, <code>LayoutParams.isViewRemoved()</code> will return true for the given view. Our example counts the number of removed views so we have a rough idea of how much space will get filled by appearing views.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLayoutChildren</span><span class="o">(</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">Recycler</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">State</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SparseIntArray</span> <span class="n">removedCache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * During pre-layout, we need to take note of any views that are</span>
</span><span class='line'><span class="cm">     * being removed in order to handle predictive animations</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">removedCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SparseIntArray</span><span class="o">(</span><span class="n">getChildCount</span><span class="o">());</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">getChildCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>            <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">isItemRemoved</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">//Track these view removals as visible</span>
</span><span class='line'>                <span class="n">removedCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">getViewPosition</span><span class="o">(),</span> <span class="n">REMOVE_VISIBLE</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="err">…</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Fill the grid for the initial layout of views</span>
</span><span class='line'>    <span class="n">fillGrid</span><span class="o">(</span><span class="n">DIRECTION_NONE</span><span class="o">,</span> <span class="n">childLeft</span><span class="o">,</span> <span class="n">childTop</span><span class="o">,</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">state</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">(),</span> <span class="n">removedCache</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>TIP: During pre-layout, <code>RecyclerView</code> attempts to map the adapter positions of your views to their “old” locations (meaning before the data set change). When you ask for a view by position, expect that position to be the initial position of that item view. Beware of trying to transform them yourself between pre-layout and “real” layout.</p>

<p>The final change in the example comes as a modification to fillGrid() in which we will attempt to lay out “N” additional views (per row) as appearing views, where N is the number of visible views being removed. These views will always be filled in from the right on a removal, so they are computed as the positions following the last visible column:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">fillGrid</span><span class="o">(</span><span class="kt">int</span> <span class="n">direction</span><span class="o">,</span> <span class="kt">int</span> <span class="n">emptyLeft</span><span class="o">,</span> <span class="kt">int</span> <span class="n">emptyTop</span><span class="o">,</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">Recycler</span> <span class="n">recycler</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">preLayout</span><span class="o">,</span> <span class="n">SparseIntArray</span> <span class="n">removedPositions</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">getVisibleChildCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">nextPosition</span> <span class="o">=</span> <span class="n">positionOfIndex</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">mVisibleColumnCount</span> <span class="o">==</span> <span class="o">(</span><span class="n">mVisibleColumnCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">leftOffset</span> <span class="o">=</span> <span class="n">startLeftOffset</span><span class="o">;</span>
</span><span class='line'>            <span class="n">topOffset</span> <span class="o">+=</span> <span class="n">mDecoratedChildHeight</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//During pre-layout, on each column end, apply any additional appearing views</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">preLayout</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">layoutAppearingViews</span><span class="o">(</span><span class="n">recycler</span><span class="o">,</span> <span class="n">view</span><span class="o">,</span> <span class="n">nextPosition</span><span class="o">,</span> <span class="n">removedPositions</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="err">…</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">leftOffset</span> <span class="o">+=</span> <span class="n">mDecoratedChildWidth</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">layoutAppearingViews</span><span class="o">(</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">Recycler</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">View</span> <span class="n">referenceView</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">referencePosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">extraCount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//Nothing to do...</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">extraCount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">extra</span> <span class="o">&lt;=</span> <span class="n">extraCount</span><span class="o">;</span> <span class="n">extra</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//Grab the next position after the reference</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">extraPosition</span> <span class="o">=</span> <span class="n">referencePosition</span> <span class="o">+</span> <span class="n">extra</span><span class="o">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">extraPosition</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">extraPosition</span> <span class="o">&gt;=</span> <span class="n">getItemCount</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">//Can&#39;t do anything with this</span>
</span><span class='line'>            <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Obtain additional position views that we expect to appear</span>
</span><span class='line'><span class="cm">         * as part of the animation.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">View</span> <span class="n">appearing</span> <span class="o">=</span> <span class="n">recycler</span><span class="o">.</span><span class="na">getViewForPosition</span><span class="o">(</span><span class="n">extraPosition</span><span class="o">);</span>
</span><span class='line'>        <span class="n">addView</span><span class="o">(</span><span class="n">appearing</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Find layout delta from reference position</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">newRow</span> <span class="o">=</span> <span class="n">getGlobalRowOfPosition</span><span class="o">(</span><span class="n">extraPosition</span> <span class="o">+</span> <span class="n">offset</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">rowDelta</span> <span class="o">=</span> <span class="n">newRow</span> <span class="o">-</span> <span class="n">getGlobalRowOfPosition</span><span class="o">(</span><span class="n">referencePosition</span> <span class="o">+</span> <span class="n">offset</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">newCol</span> <span class="o">=</span> <span class="n">getGlobalColumnOfPosition</span><span class="o">(</span><span class="n">extraPosition</span> <span class="o">+</span> <span class="n">offset</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">colDelta</span> <span class="o">=</span> <span class="n">newCol</span> <span class="o">-</span> <span class="n">getGlobalColumnOfPosition</span><span class="o">(</span><span class="n">referencePosition</span> <span class="o">+</span> <span class="n">offset</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">layoutTempChildView</span><span class="o">(</span><span class="n">appearing</span><span class="o">,</span> <span class="n">rowDelta</span><span class="o">,</span> <span class="n">colDelta</span><span class="o">,</span> <span class="n">referenceView</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside the <code>layoutAppearingViews()</code> helper, each additional appearing view is laid out at it’s “global” position (i.e. the row/column position it would occupy in the grid). This location is off-screen, but gives the framework the data it needs to produce a starting point for the animation to slide these views in.</p>

<h2>Changes for the “Real” Layout</h2>

<p>We’ve already discussed the basics of what to do during your layout in Part 1, but we’ll have to tweak the formula a bit with our animation support added. The one additional step will be to determine if we have any disappearing views. In our example, this is done by running a normal layout pass, and then determining if there are any views left in the Recycler’s scrap heap.NOTE: We can use the scrap heap in this way because our layout logic always calls <code>detachAndScrapAttachedViews()</code> before starting each layout pass. As discussed previously, this is the best practice to adhere to in your layouts.</p>

<p>Views still in scrap that aren’t considered removed are disappearing views. We need to lay these views out in their off-screen positions so the animation system can slide them out of view (instead of just fading them out).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLayoutChildren</span><span class="o">(</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">Recycler</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">State</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">state</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">recycler</span><span class="o">.</span><span class="na">getScrapList</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span><span class="o">&gt;</span> <span class="n">scrapList</span> <span class="o">=</span> <span class="n">recycler</span><span class="o">.</span><span class="na">getScrapList</span><span class="o">();</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;</span> <span class="n">disappearingViews</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;(</span><span class="n">scrapList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">scrapList</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">itemView</span><span class="o">;</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">child</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(!</span><span class="n">lp</span><span class="o">.</span><span class="na">isItemRemoved</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">disappearingViews</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">View</span> <span class="n">child</span> <span class="o">:</span> <span class="n">disappearingViews</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">layoutDisappearingView</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">layoutDisappearingView</span><span class="o">(</span><span class="n">View</span> <span class="n">disappearingChild</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * LayoutManager has a special method for attaching views that</span>
</span><span class='line'><span class="cm">     * will only be around long enough to animate.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">addDisappearingView</span><span class="o">(</span><span class="n">disappearingChild</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Adjust each disappearing view to its proper place</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutParams</span><span class="o">)</span> <span class="n">disappearingChild</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">newRow</span> <span class="o">=</span> <span class="n">getGlobalRowOfPosition</span><span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">getViewPosition</span><span class="o">());</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">rowDelta</span> <span class="o">=</span> <span class="n">newRow</span> <span class="o">-</span> <span class="n">lp</span><span class="o">.</span><span class="na">row</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">newCol</span> <span class="o">=</span> <span class="n">getGlobalColumnOfPosition</span><span class="o">(</span><span class="n">lp</span><span class="o">.</span><span class="na">getViewPosition</span><span class="o">());</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">colDelta</span> <span class="o">=</span> <span class="n">newCol</span> <span class="o">-</span> <span class="n">lp</span><span class="o">.</span><span class="na">column</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">layoutTempChildView</span><span class="o">(</span><span class="n">disappearingChild</span><span class="o">,</span> <span class="n">rowDelta</span><span class="o">,</span> <span class="n">colDelta</span><span class="o">,</span> <span class="n">disappearingChild</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>CAUTION: Laying out views (and, thus, adding them to the container) removes them from the scrap list. Be careful to note the views you need from scrap before you start making changes, or you will end up with concurrent modification issues on the collection.</p>

<p>Similar to our code for the appearing views, <code>layoutDisappearingView()</code> places each remaining view at it’s “global” position as the final layout location. This gives the framework the information that it needs to slide these views out in the proper direction during the animation.</p>

<p>The following image should help to visualize the <code>FixedGridLayoutManager</code> example:</p>

<ul>
<li>The black box represents the RecyclerView visible bounds.</li>
<li>Red View: Item removed from the data set.</li>
<li>Green Views (Appearing views): Not initially present, but laid out off-screen during pre-layout.</li>
<li>Purple Views (Disappearing views): Initially placed in their original locations during pre-layout, then laid out off-screen during the “real” layout phase.</li>
</ul>


<center><img src="/images/building_recyclerview_layoutmanager_simple_animation.gif" width="667" height="400"></center>


<h2>Reacting to Off-Screen Changes</h2>

<p>You may have noticed that our ability to determine a removal change in the last section hinged on the visible views. What if the change occurs outside the visible bounds? Depending on your layout structure, a change like this may still require you to adjust the layout for a better animation experience.</p>

<p>Luckily, the adapter posts these changes to your <code>LayoutManager</code> as well. You can override <code>onItemsRemoved()</code>, <code>onItemsMoved()</code>, <code>onItemsAdded()</code>, or <code>onItemsChanged()</code> to react to these events even if they occur in a view range that isn’t reflected in the current layout. These methods will give you the position and range of the change.</p>

<p>When the removed range occurs outside the visible area, <code>onItemRemoved()</code> is called before pre-layout. This allows us to collect data about the change that we may need in order to best support any appearing view changes that might be caused by this event.</p>

<p>In our example, we collect these removals in the same way as before, but mark them with a different type.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemsRemoved</span><span class="o">(</span><span class="n">RecyclerView</span> <span class="n">recyclerView</span><span class="o">,</span> <span class="kt">int</span> <span class="n">positionStart</span><span class="o">,</span> <span class="kt">int</span> <span class="n">itemCount</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mFirstChangedPosition</span> <span class="o">=</span> <span class="n">positionStart</span><span class="o">;</span>
</span><span class='line'>    <span class="n">mChangedPositionCount</span> <span class="o">=</span> <span class="n">itemCount</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLayoutChildren</span><span class="o">(</span><span class="n">RecyclerView</span><span class="o">.</span><span class="na">Recycler</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">State</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SparseIntArray</span> <span class="n">removedCache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * During pre-layout, we need to take note of any views that are</span>
</span><span class='line'><span class="cm">     * being removed in order to handle predictive animations</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Track view removals that happened out of bounds (i.e. off-screen)</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">removedCache</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mChangedPositionCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mFirstChangedPosition</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">mFirstChangedPosition</span> <span class="o">+</span> <span class="n">mChangedPositionCount</span><span class="o">);</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">removedCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">REMOVE_INVISIBLE</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Fill the grid for the initial layout of views</span>
</span><span class='line'>    <span class="n">fillGrid</span><span class="o">(</span><span class="n">DIRECTION_NONE</span><span class="o">,</span> <span class="n">childLeft</span><span class="o">,</span> <span class="n">childTop</span><span class="o">,</span> <span class="n">recycler</span><span class="o">,</span> <span class="n">state</span><span class="o">.</span><span class="na">isPreLayout</span><span class="o">(),</span> <span class="n">removedCache</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>TIP: This method is sill called when the removed items are visible. In that case, however, it is called after pre-layout. This is why our example still gathers data from the visible removed views when they are present.</p>

<p>With all this in place, we can run the sample application again. We can see the disappearing items on the left sliding off to rejoin the end of their previous rows. The new appearing items on the right slide properly into place alongside the existing grid. Now, the only view fading out in our new animation is the view that was actually removed!</p>

<center><img src="/images/building_recyclerview_layoutmanager_predictive_removal_animation.gif" width="379" height="677"></center>


<h2>More To Come…</h2>

<p>This was supposed to be the end of this series, I swear! However, there were some interesting issues that came up in building the animations that are specific to the <code>FixedGridLayoutManager</code> use case, and not necessarily all custom implementations. So in the next (and final…I promise this time) post, I’ll address what those challenges were.</p>

<p>The framework will attempt to animate views if your adapter uses stable IDs, which provides enough data to guess which views are removed/added/etc.</p>

<h2>reference</h2>

<ul>
<li><a href="http://wiresareobsolete.com/2015/02/recyclerview-layoutmanager-3/">Building a RecyclerView LayoutManager – Part 3</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Solarex</span></span>

      








  


<time datetime="2016-01-13T00:48:00+08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2016</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/dev/'>dev</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/01/11/building-a-recyclerview-layoutmanager-part-ii/" title="Previous Post: Building a RecyclerView LayoutManager part II">&laquo; Building a RecyclerView LayoutManager part II</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/01/15/building-a-recyclerview-layoutmanager-part-iv/" title="Next Post: Building a RecyclerView LayoutManager part IV">Building a RecyclerView LayoutManager part IV &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
        
        <li class="post">
            <a href="/blog/2019/08/12/singleton-pattern/">单例模式</a>
        </li>
        
        <li class="post">
            <a href="/blog/2019/08/10/lock-free-multithreading-with-atomic-operations/">Lock-free multithreading with atomic operations</a>
        </li>
        
        <li class="post">
            <a href="/blog/2019/08/09/introduction-to-thread-synchronization/">Introduction to thread synchronization</a>
        </li>
        
        <li class="post">
            <a href="/blog/2019/08/07/a-gentle-introduction-to-multithreading/">A gentle introduction to multithreading</a>
        </li>
        
        <li class="post">
            <a href="/blog/2019/08/05/floyd-cycle-detection-in-linkedlist/">检测链表中是否有环</a>
        </li>
        
    </ul>
    <h1>Notes</h1>
    <ul id="recent_posts">
        <li class="post">
            <a href="https://solarex.github.io/reading-notes/">读书笔记</a>
        </li>
        <li class="post">
            <a href="https://solarex.github.io/learning-notes/">学习笔记</a>
        </li>
        <li class="post">
            <a href="https://solarex.github.io/leetcode-solution-comments/">LeetCode题解笔记</a>
        </li>
    </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/flyfire">@flyfire</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'flyfire',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/107384356964511479070?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Solarex -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'solarex-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://Solarex.github.io/blog/2016/01/13/building-a-recyclerview-layoutmanager-part-iii/';
        var disqus_url = 'http://Solarex.github.io/blog/2016/01/13/building-a-recyclerview-layoutmanager-part-iii/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
